# Story 2.7: End-to-End MCP Integration Test

## Status

Ready for Review

## Story

**As a** QA engineer,  
**I want** test suite que simula LLM client interagindo com MCP server para workflows completos,  
**so that** valido que integration MCP + Semantic Search + Bitbucket API funciona end-to-end.

## Acceptance Criteria

1. Test suite `tests/integration/e2e-mcp.test.ts` criado usando MCP SDK test utilities
2. Suite simula MCP client connecting via stdio transport
3. Test Workflow 1: Search → Get → Call
   - Client invoca `search_ids` com query "create new issue"
   - Asserts: returns operation IDs, top result is `create_issue` com score >0.9
   - Client invoca `get_id` com operation_id returned
   - Asserts: returns schema com parameters, examples
   - Client invoca `call_id` com valid params (mock Bitbucket API)
   - Asserts: returns success response
4. Test Workflow 2: Invalid Input Handling
   - Client invoca `call_id` com invalid params
   - Asserts: returns validation errors with descriptive messages
5. Test Workflow 3: Bitbucket API Error Handling
   - Client invoca `call_id`, mock Bitbucket returns 401 auth error
   - Asserts: returns MCP error with clear message "Authentication failed: check your Bitbucket credentials"
6. Suite valida: protocol handshake, tool listing, error responses format, logging output
7. Suite executa em CI pipeline usando mock Bitbucket API
8. Suite tem documentation de como executar manually contra real Bitbucket DC instance

## Tasks / Subtasks

- [x] Task 1: Criar estrutura base do E2E test suite (AC: 1)
  - [x] Criar arquivo `tests/e2e/e2e-mcp.test.ts` seguindo unified-project-structure
  - [x] Importar dependências necessárias:
    ```typescript
    import { describe, it, expect, beforeAll, afterAll, vi } from 'vitest';
    import { spawn, ChildProcess } from 'child_process';
    import { EventEmitter } from 'events';
    ```
  - [x] Criar helper class `MCPTestClient` que simula MCP client via stdio transport
  - [x] Implementar métodos: `start()`, `stop()`, `initialize()`, `callTool(name, params)`
  - [x] [Source: architecture/testing-strategy.md#E2E Tests + backend-architecture.md#MCP Server]

- [x] Task 2: Implementar Mock Bitbucket Server helper (AC: 3, 5)
  - [x] Criar arquivo `tests/helpers/mock-bitbucket-server.ts`
  - [x] Usar http server (node:http) para simular Bitbucket DC API
  - [x] Implementar método `mockResponse(method, path, response)` para configurar mock responses
  - [x] Implementar lifecycle: `start(port)`, `stop()`, `reset()`
  - [x] [Source: architecture/testing-strategy.md#Backend API Test]

- [x] Task 3: Implementar MCPTestClient helper (AC: 2, 6)
  - [x] Criar arquivo `tests/helpers/mcp-test-client.ts`
  - [x] Spawn MCP server process usando `spawn('node', ['dist/index.js'])` com stdio pipes
  - [x] Implementar JSON-RPC protocol communication via stdin/stdout com line-buffering
  - [x] Implementar `initialize()` method que envia MCP protocol handshake (initialize request)
  - [x] Implementar `listTools()` method que retorna available tools do server
  - [x] [Source: architecture/backend-architecture.md#MCP Protocol + tech-stack.md#MCP SDK]

- [x] Task 4: Implementar Test Workflow 1 - Search → Get → Call (AC: 3)
  - [x] Criar describe block "Workflow 1: Search → Get → Call"
  - [x] Setup: Start mock Bitbucket server, start MCP server, initialize client
  - [x] Test Step 1 - Search
  - [x] Test Step 2 - Get Schema
  - [x] Test Step 3 - Execute Operation
  - [x] [Source: epic-2-mcp-server-operation-execution.md#Story 2.7 AC3]

- [x] Task 5: Implementar Test Workflow 2 - Invalid Input Handling (AC: 4)
  - [x] Criar describe block "Workflow 2: Invalid Input Handling"
  - [x] Test: call_id com missing required parameter
  - [x] Test: call_id com invalid parameter type
  - [x] [Source: epic-2-mcp-server-operation-execution.md#Story 2.5 Validation]

- [x] Task 6: Implementar Test Workflow 3 - Bitbucket API Error Handling (AC: 5)
  - [x] Criar describe block "Workflow 3: Bitbucket API Error Handling"
  - [x] Test: 401 Authentication Error
  - [x] Test: 429 Rate Limit Error
  - [x] Test: 500 Server Error com retry
  - [x] [Source: epic-2-mcp-server-operation-execution.md#Story 2.4 Retry Logic]

- [x] Task 7: Implementar validação de protocol handshake e tool listing (AC: 6)
  - [x] Test: MCP initialize handshake
  - [x] Test: Tool listing
  - [x] Test: Error response format consistency
  - [x] [Source: architecture/backend-architecture.md#MCP Protocol Handler]

- [x] Task 8: Configurar suite para executar em CI pipeline (AC: 7)
  - [x] Criar script `npm run test:e2e` em package.json
  - [x] Ensure E2E tests usa mock Bitbucket server (não real instance) em CI
  - [x] Add timeout de 60s para E2E test suite (tests podem ser mais lentos)
  - [x] [Source: architecture/unified-project-structure.md#CI/CD]

- [x] Task 9: Criar documentação para manual testing contra real Bitbucket DC (AC: 8)
  - [x] Criar arquivo `tests/e2e/README.md` com instruções
  - [x] Criar script `npm run test:e2e:real` que seta `E2E_USE_REAL_BITBUCKET=true`
  - [x] Adicionar condicional no test code para usar real Bitbucket quando env var está set
  - [x] [Source: epic-2-mcp-server-operation-execution.md#Story 2.7 AC8 + AC10 Story 2.6]

- [x] Task 10: Implementar lifecycle hooks e cleanup (AC: 2, 7)
  - [x] Implementar beforeAll hook
  - [x] Implementar afterAll hook
  - [x] Implementar afterEach hook para reset mock Bitbucket responses
  - [x] [Source: architecture/testing-strategy.md#E2E Test Structure]

## Dev Notes

### Testing Standards

**Test Location:**
- E2E tests devem estar em `tests/e2e/` directory
- Helper utilities em `tests/helpers/`
- Test fixtures em `tests/fixtures/` se necessário
[Source: architecture/unified-project-structure.md#Test Organization]

**Testing Framework:**
- Usar Vitest como test runner
- Import pattern: `import { describe, it, expect, beforeAll, afterAll } from 'vitest';`
- Test file naming: `*.test.ts`
[Source: architecture/tech-stack.md#Testing Framework]

**Test Standards:**
- E2E tests representam 5% do test pyramid
- Focus em critical happy paths e major error scenarios
- Tests devem ser idempotent (podem rodar múltiplas vezes)
- Usar timeouts adequados (E2E tests são mais lentos que unit tests)
- Mock external dependencies (Bitbucket API) em CI, allow real testing manual
[Source: architecture/testing-strategy.md#Testing Pyramid]

**Assertions:**
- Usar expect() assertions do Vitest
- Be specific: prefer `.toBe()`, `.toEqual()`, `.toContain()` over generic checks
- Test both success and failure scenarios
- Validate response structure, não apenas existence
[Source: architecture/coding-standards.md#Test Coverage]

### MCP Protocol Context

**MCP Server Communication:**
- MCP server usa stdio transport (stdin/stdout)
- Protocol é JSON-RPC 2.0 based
- **CRITICAL**: Stdio responses may come in chunks or multiple messages per data event
  - Must implement line-buffering: accumulate data until complete line (ending with `\n`)
  - Parse each complete line as separate JSON-RPC message
  - Keep incomplete lines in buffer for next data event
- Request format:
  ```typescript
  {
    jsonrpc: "2.0",
    id: number,
    method: "tools/call" | "initialize" | "tools/list",
    params: { name: string, arguments: object }
  }
  ```
- Response format:
  ```typescript
  {
    jsonrpc: "2.0",
    id: number,
    result: object | array
  }
  ```
[Source: architecture/backend-architecture.md#MCP Protocol Handler]

**MCP Tools Available:**
- `search_ids`: Query → Operation IDs (semantic search)
- `get_id`: Operation ID → Full schema with examples
- `call_id`: Operation ID + Params → Execute Bitbucket API call
[Source: epic-2-mcp-server-operation-execution.md#Tools Summary]

**Tool Input/Output Schemas:**
- All tools têm input schema validation via Zod
- Errors retornam format: `{ error: { code: number, message: string, details?: string } }`
- Success retorna: `{ content: [{ type: 'text', text: string }] }`
[Source: architecture/data-models.md#Operation Interface]

### Workflow Context from Previous Stories

**Story 2.1 - MCP Server Foundation:**
- Server implementa lifecycle: startup, ready state, graceful shutdown
- Global error handling: uncaught exceptions não crasham process
- Structured logging (pino) para all events
[Source: docs/stories/2.1.mcp-server-foundation.md]

**Story 2.2 - search_ids Tool:**
- Retorna top 5 operations por default (customizable via limit)
- Similarity score baseado em cosine similarity (0-1)
- Query deve ser non-empty, limit entre 1-20
[Source: docs/stories/2.2.mcp-tool-search-ids.md]

**Story 2.4 - Bitbucket Client Service:**
- Implementa retry logic: 3 retries com exponential backoff (100ms, 500ms, 2s)
- Rate limiting: max 100 req/s (token bucket algorithm)
- Timeout: 30s default per request
- Error transformation: 401/403→AuthError, 429→RateLimitError, 5xx→ServerError
[Source: docs/stories/2.4.bitbucket-api-client-service.md]

**Story 2.5 - Input Validation:**
- Validation usa Zod schemas generated from OpenAPI spec
- Errors são LLM-readable: "Parameter 'X' is required but missing"
- Nested objects e arrays validados recursively
[Source: docs/stories/2.5.input-validation-against-schemas.md]

**Story 2.6 - call_id Tool:**
- Timeout: 60s (configurable) para long-running operations
- Audit trail: todas mutations (POST/PUT/DELETE) logadas com full params
- Response normalization: success as-is, errors normalized com clear messages
[Source: docs/stories/2.6.mcp-tool-call-id.md]

### Critical Implementation Notes

**Stdio Transport Testing:**
- Spawn MCP server como child process: `spawn('node', ['dist/index.js'])`
- Use stdin.write() para send requests, stdout.on('data') para receive responses
- **MUST implement line-buffering**: stdout data events may contain:
  - Partial messages (incomplete JSON)
  - Multiple complete messages in one chunk
  - Messages split across multiple data events
- **Implementation pattern**:
  ```typescript
  let buffer = '';
  process.stdout.on('data', (data) => {
    buffer += data.toString();
    const lines = buffer.split('\n');
    buffer = lines.pop() || ''; // Keep incomplete line
    lines.forEach(line => {
      if (line.trim()) {
        const message = JSON.parse(line);
        // Process message
      }
    });
  });
  ```
- Set timeouts para prevent hanging (5s per request, 30s total suite)
[Source: architecture/backend-architecture.md#Server Entry Point]

**Mock Bitbucket Server Setup:**
- Use node:http (não express) para minimize dependencies
- Mock server deve reset between tests (afterEach hook)
- Support dynamic response configuration: `mockResponse(method, path, response)`
- Return proper HTTP status codes e JSON content-type header
[Source: architecture/testing-strategy.md#Backend API Test]

**Error Scenario Testing:**
- Test validation errors (missing params, wrong types)
- Test Bitbucket API errors (401, 429, 500)
- Test timeout scenarios
- Test retry behavior (500 error → retry → success)
- All error messages devem ser descriptive e actionable
[Source: architecture/coding-standards.md#Error Handling]

**CI/CD Integration:**
- E2E tests devem passar em CI usando mock Bitbucket server
- Não executar against real Bitbucket em CI (credential/permission issues)
- Provide separate script `test:e2e:real` para manual testing
- Build must succeed before E2E tests run (`npm run build` prerequisite)
[Source: architecture/unified-project-structure.md#GitHub Actions CI/CD]

### Source Tree Context

```plaintext
tests/
├── e2e/
│   ├── e2e-mcp.test.ts           # CRIAR: Main E2E test suite (this story)
│   └── README.md                  # CRIAR: Manual testing documentation
├── helpers/
│   ├── mcp-test-client.ts        # CRIAR: MCP client helper
│   └── mock-bitbucket-server.ts       # CRIAR: Mock Bitbucket API server
└── fixtures/
    └── sample-responses.json      # OPCIONAL: Sample Bitbucket responses
```

[Source: architecture/unified-project-structure.md#Tests Organization]

### Key Technical Constraints

- **TypeScript strict mode:** No `any` types, usar proper interfaces
- **No console.log:** Use pino Logger for all logging
- **Async/await only:** No `.then()/.catch()` chains
- **Immutability:** Prefer const over let, no array/object mutation
- **Test coverage:** Minimum 80% line coverage (CI fails below)
[Source: architecture/coding-standards.md#Critical Rules]

### Dependencies Required

```typescript
// Production dependencies (já instaladas em stories anteriores)
import { spawn, ChildProcess } from 'child_process';
import { EventEmitter } from 'events';
import http from 'http';

// Test dependencies (já instaladas)
import { describe, it, expect, beforeAll, afterAll, afterEach, vi } from 'vitest';
```

[Source: architecture/tech-stack.md#Tech Stack Table]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-16 | 1.1 | Story approved for implementation | Bob (Scrum Master) |
| 2025-10-16 | 1.2 | Story validated - minor note: add line-buffering handling for stdio | Sarah (Product Owner) |
| 2025-10-16 | 1.3 | Fixed: Added complete line-buffering implementation pattern for stdio transport | Sarah (Product Owner) |
| 2025-10-16 | 1.4 | Final validation completed - story ready for implementation | GitHub Copilot |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (new)

### Debug Log References

- Fixed index.ts initialization to properly register MCP tools with all required services
- Fixed populate-db.ts to handle JSON format with metadata wrappers (camelCase → snake_case mapping)
- Generated embeddings and populated SQLite database with operations
- Implemented MockBitbucketServer helper for HTTP API mocking
- Implemented MCPTestClient helper with line-buffering for stdio transport
- Created comprehensive E2E test suite covering 11 test scenarios
- All tests passing: protocol handshake, tool listing, search→get→call workflow, validation errors, API error handling

### Completion Notes List

- ✅ Created `tests/e2e/e2e-mcp.test.ts` with 11 comprehensive integration tests
- ✅ Created `tests/helpers/mock-bitbucket-server.ts` for HTTP API mocking
- ✅ Created `tests/helpers/mcp-test-client.ts` with stdio transport and line-buffering
- ✅ Fixed `src/index.ts` to properly initialize all services and register MCP tools
- ✅ Fixed `scripts/populate-db.ts` to handle JSON format with metadata (operations/embeddings keys)
- ✅ Generated embeddings and populated database (430 operations)
- ✅ Added npm scripts: `test:e2e` and `test:e2e:real`
- ✅ Created `tests/e2e/README.md` with comprehensive manual testing documentation
- ✅ All 11 tests passing: 3 protocol tests, 1 workflow test, 3 validation tests, 4 error handling tests
- ✅ Tests validate: MCP handshake, tool listing, search→get→call workflow, validation errors, 401/429/500 error handling with retries

### File List

**New Files:**
- `tests/e2e/e2e-mcp.test.ts` - Main E2E test suite (11 tests)
- `tests/helpers/mock-bitbucket-server.ts` - HTTP mock server for Bitbucket API
- `tests/helpers/mcp-test-client.ts` - MCP client helper with stdio transport
- `tests/e2e/README.md` - Manual testing documentation

**Modified Files:**
- `src/index.ts` - Added service initialization and tool registration
- `scripts/populate-db.ts` - Fixed JSON parsing for operations/embeddings format
- `package.json` - Added `test:e2e` and `test:e2e:real` scripts
- `data/embeddings.json` - Generated (9.7MB, 430 operations)
- `data/embeddings.db` - Populated (3.57MB, 430 operations + embeddings)

**Dependencies:**
- No new dependencies added (all existing: vitest, better-sqlite3, @modelcontextprotocol/sdk)

## QA Results

_To be filled by QA agent after review_

