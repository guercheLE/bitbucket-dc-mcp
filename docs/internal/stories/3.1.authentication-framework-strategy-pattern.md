# Story 3.1: Authentication Framework & Strategy Pattern

## Status

Ready for Review

## Story

**As a** developer,  
**I want** framework de autenticação com strategy pattern suportando múltiplos auth methods,  
**so that** posso adicionar OAuth2, PAT, OAuth1.0a, e Basic auth com código extensível e testável.

## Acceptance Criteria

1. Interface `AuthStrategy` em `src/auth/auth-strategy.ts` definida com métodos: `authenticate(config): Promise<Credentials>`, `refreshToken?(credentials): Promise<Credentials>`, `validateCredentials(credentials): boolean`
2. Classe base `AuthManager` em `src/auth/auth-manager.ts` implementada com: strategy selection, credentials caching, refresh logic
3. AuthManager seleciona strategy baseado em config: `auth.method: 'oauth2' | 'pat' | 'oauth1' | 'basic'`
4. AuthManager implementa credentials lifecycle: load from storage → validate → use → refresh if needed → persist
5. AuthManager has error handling: invalid credentials, expired tokens, auth failures retornam typed errors
6. AuthManager integra com BitbucketClientService: adiciona auth headers (Authorization, OAuth headers) automaticamente em requests
7. AuthManager tem logging: auth method used, token refresh events, auth failures
8. Unit tests validam: strategy selection, credentials validation, refresh logic, error handling

## Tasks / Subtasks

- [x] Task 1: Criar interface AuthStrategy base (AC: 1)
  - [x] Criar arquivo `src/auth/auth-strategy.ts`
  - [x] Definir interface TypeScript `AuthStrategy` com métodos: `authenticate(config): Promise<Credentials>`, `refreshToken?(credentials): Promise<Credentials>`, `validateCredentials(credentials): boolean`
  - [x] Adicionar type `AuthMethod = 'oauth2' | 'pat' | 'oauth1' | 'basic'`
  - [x] Adicionar TSDoc comments explicando o Strategy Pattern e quando usar cada método

- [x] Task 2: Implementar AuthManager base class (AC: 2, 3, 4)
  - [x] Criar arquivo `src/auth/auth-manager.ts`
  - [x] Implementar constructor recebendo: `CredentialStorage`, `Logger`, `Config`
  - [x] Implementar método `selectStrategy(authMethod: AuthMethod): AuthStrategy` que retorna strategy apropriada
  - [x] Implementar credentials lifecycle no método `getCredentials(): Promise<Credentials>`: load from storage → validate → refresh if needed → return
  - [x] Adicionar in-memory cache para credentials (evitar múltiplos loads do keychain)
  - [x] Implementar método `refreshCredentials(credentials: Credentials): Promise<Credentials>` que chama strategy.refreshToken() se disponível

- [x] Task 3: Implementar credentials validation logic (AC: 4)
  - [x] Adicionar método `validateCredentials(credentials: Credentials): boolean` que chama strategy.validateCredentials()
  - [x] Validar expiration: check `expires_at` timestamp se presente
  - [x] Validar required fields baseado em auth method (ex: OAuth2 precisa de `access_token`)
  - [x] Log validation failures para debugging

- [x] Task 4: Implementar error handling e typed errors (AC: 5)
  - [x] Criar `src/auth/errors.ts` com classes: `AuthenticationError`, `TokenExpiredError`, `InvalidCredentialsError`
  - [x] AuthenticationError extends AppError (base error class from `src/core/errors.ts`)
  - [x] Throw InvalidCredentialsError quando credentials validation falha
  - [x] Throw TokenExpiredError quando token expirado e refresh falha
  - [x] Adicionar retry logic: se credentials inválidas, tentar refresh antes de falhar

- [x] Task 5: Integrar AuthManager com BitbucketClientService (AC: 6)
  - [x] Implementar método `getAuthHeaders(): Promise<Record<string, string>>` que retorna headers apropriados
  - [x] OAuth2/PAT: retornar `{ Authorization: 'Bearer <token>' }`
  - [x] Basic Auth: retornar `{ Authorization: 'Basic <base64>' }`
  - [x] OAuth1: retornar `{ Authorization: 'OAuth <oauth_params>' }`
  - [x] Atualizar `BitbucketClientService` para chamar `authManager.getAuthHeaders()` antes de cada request

- [x] Task 6: Adicionar structured logging para auth events (AC: 7)
  - [x] Log auth method selecionado: `logger.info('Auth method selected', { authMethod })`
  - [x] Log token refresh events: `logger.info('Token refreshed', { authMethod, expiresAt })`
  - [x] Log auth failures: `logger.error('Authentication failed', { authMethod, error })`
  - [x] Sanitize credentials em logs: substituir tokens por `***`

- [x] Task 7: Implementar unit tests para AuthManager (AC: 8)
  - [x] Criar `tests/unit/auth/auth-manager.test.ts`
  - [x] Test strategy selection: dado authMethod='oauth2', retorna OAuth2Strategy
  - [x] Test credentials lifecycle: load → validate → use (mock CredentialStorage)
  - [x] Test token refresh: quando credentials expiradas, refresh é chamado
  - [x] Test error handling: credentials inválidas throwam InvalidCredentialsError
  - [x] Test caching: múltiplas chamadas para getCredentials() não fazem múltiplos loads

- [x] Task 8: Criar stub implementations para strategies (para testes)
  - [x] Criar `src/auth/strategies/stub-strategy.ts` que implementa AuthStrategy
  - [x] Stub retorna credentials mockadas para permitir testes de integração
  - [x] Adicionar configuração para habilitar stub mode (ex: `auth.method: 'stub'`)

- [x] Task 9: Documentar architecture decisions e usage
  - [x] Adicionar TSDoc comments para AuthManager class e métodos públicos
  - [x] Adicionar exemplos de uso nos comments (`@example`)
  - [x] Documentar o Strategy Pattern e como adicionar novas strategies

## Dev Notes

### Authentication Architecture Context
[Source: architecture/backend-architecture.md#Authentication]

**Strategy Pattern Implementation:**
The authentication system uses the Strategy Pattern to support multiple auth methods (OAuth2, PAT, OAuth1.0a, Basic). Each auth method is implemented as a separate strategy class that implements the `AuthStrategy` interface. The `AuthManager` class acts as the context that selects and uses the appropriate strategy based on configuration.

**Key Design Decisions:**
- **Dependency Injection:** AuthManager receives dependencies (CredentialStorage, Logger, Config) via constructor for testability
- **Credentials Caching:** In-memory cache reduces keychain access frequency
- **Graceful Degradation:** If refresh fails, system tries re-authentication before failing
- **Security:** All auth tokens must be sanitized in logs and error messages

### Data Models
[Source: architecture/data-models.md#Credentials]

#### Credentials Interface

```typescript
type AuthMethod = 'oauth2' | 'pat' | 'oauth1' | 'basic';

interface Credentials {
  bitbucket_url: string;
  auth_method: AuthMethod;
  // OAuth2/PAT
  access_token?: string;
  refresh_token?: string;
  expires_at?: Date;
  // Basic Auth
  username?: string;
  password?: string; // Encrypted in keychain
  // OAuth 1.0a
  consumer_key?: string;
  consumer_secret?: string;
  oauth_token?: string;
  oauth_token_secret?: string;
}
```

#### CredentialStorage Interface

```typescript
interface CredentialStorage {
  save(key: string, credentials: Credentials): Promise<void>;
  load(key: string): Promise<Credentials | null>;
  delete(key: string): Promise<void>;
  list(): Promise<string[]>;
}
```

**Note:** CredentialStorage implementation will be created in Story 3.5. For this story, use a mock or stub implementation in tests.

### Error Handling
[Source: architecture/error-handling-strategy.md#Error Classes]

**Custom Error Classes:**
```typescript
class AuthenticationError extends AppError {
  constructor(message: string) {
    super('AUTHENTICATION_ERROR', message, 401);
  }
}

class InvalidCredentialsError extends AuthenticationError {
  constructor(message: string) {
    super('INVALID_CREDENTIALS', message);
  }
}

class TokenExpiredError extends AuthenticationError {
  constructor(message: string) {
    super('TOKEN_EXPIRED', message);
  }
}
```

**Error Handling Pattern:**
- Validate credentials → throw InvalidCredentialsError if invalid
- Check token expiration → throw TokenExpiredError if expired and refresh fails
- Log all auth errors with sanitized credentials (no tokens in logs)

### Project Structure
[Source: architecture/unified-project-structure.md#Auth Layer]

```plaintext
src/auth/
├── auth-manager.ts       # Strategy selector & manager
├── auth-strategy.ts      # Base interface
├── errors.ts             # Auth-specific error classes
└── strategies/
    ├── oauth2-strategy.ts    # OAuth 2.0 PKCE (Story 3.2)
    ├── pat-strategy.ts       # Personal Access Token (Story 3.3)
    ├── oauth1-strategy.ts    # OAuth 1.0a (Story 3.4)
    ├── basic-auth-strategy.ts # Basic HTTP Auth (Story 3.4)
    └── stub-strategy.ts      # Stub for testing
```

### Integration Points
[Source: epic-3-multi-auth-production-resilience.md#Story 3.5]

**Dependencies:**
- **CredentialStorage** (Story 3.5): Secure storage in OS keychain. For this story, use mock/stub.
- **BitbucketClientService** (Story 2.4): Already implemented. AuthManager will provide auth headers.
- **Logger** (Story 1.1): Already implemented. Use for structured logging.
- **Config** (Story 1.1): Already implemented. Use to read auth.method.

**Integration with BitbucketClientService:**
The `BitbucketClientService.executeOperation()` method should call `authManager.getAuthHeaders()` before making HTTP requests. This ensures all requests have correct authentication headers.

### Coding Standards
[Source: architecture/coding-standards.md]

- **Type Safety:** Use TypeScript strict mode, no `any` types
- **Naming:** Classes use PascalCase, methods use camelCase, files use kebab-case
- **Error Handling:** Always use try/catch in async functions, never swallow errors
- **Dependency Injection:** Classes receive dependencies via constructor
- **Documentation:** TSDoc comments for public APIs (`@param`, `@returns`, `@throws`, `@example`)
- **No Console.log:** Use Logger (pino) for all logging
- **Immutability:** Prefer const over let, never mutate objects/arrays

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Location:** `tests/unit/auth/auth-manager.test.ts`

**Testing Framework:** Vitest with mocking support

**Test Structure:**
```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { AuthManager } from '../../../src/auth/auth-manager.js';

describe('AuthManager', () => {
  let authManager: AuthManager;
  let mockStorage: vi.Mocked<CredentialStorage>;
  let mockLogger: vi.Mocked<Logger>;
  
  beforeEach(() => {
    // Setup mocks and instantiate AuthManager
  });
  
  it('should select correct strategy based on auth method', () => {
    // Test strategy selection logic
  });
  
  it('should load credentials from storage', async () => {
    // Test credentials loading
  });
  
  it('should refresh expired credentials', async () => {
    // Test token refresh logic
  });
  
  it('should throw InvalidCredentialsError when validation fails', async () => {
    // Test error handling
  });
});
```

**Coverage Requirement:** Minimum 80% test coverage. CI fails below this threshold.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Story created from Epic 3 | SM Agent |
| 2025-10-16 | 1.1 | Story approved for development | SM Agent |
| 2025-10-16 | 1.2 | Fixed code block formatting issues (typescript blocks), validated and approved | PO Agent |
| 2025-10-18 | 2.0 | Implemented authentication framework with Strategy Pattern, all tests passing | Dev Agent (James) |
| 2025-10-18 | 2.1 | DoD validation completed - Fixed E2E test regression by implementing auto-generation in StubCredentialStorage | Dev Agent (James) |

## Dev Agent Record

This section is populated by the development agent during implementation.

### Agent Model Used

Claude 3.5 Sonnet (2024-10-22)

### Debug Log References

None - Implementation completed without blockers. 

**Post-Implementation Fix**: E2E test regression discovered during DoD validation. Fixed by implementing auto-generation in StubCredentialStorage (2025-10-18).

### Completion Notes

- Successfully implemented authentication framework using Strategy Pattern
- Created AuthStrategy interface with authenticate(), refreshToken() (optional), and validateCredentials() methods
- Implemented AuthManager with full credentials lifecycle management (load → validate → refresh → persist → cache)
- Added comprehensive error handling with typed errors (AuthenticationError, InvalidCredentialsError, TokenExpiredError)
- Integrated AuthManager with BitbucketClientService for automatic auth header injection
- Implemented structured logging with credential sanitization
- Created StubStrategy for testing purposes
- All unit tests pass (18/18) with 100% coverage of core functionality
- Integration tests updated and passing
- **DoD Validation Fix (2025-10-18)**: Updated StubCredentialStorage to auto-generate credentials on-demand, fixing E2E test regression
- All E2E tests now passing (11/11)
- Full test suite: 209 passed, 10 skipped
- Code follows coding standards (TypeScript strict mode, TSDoc, proper error handling)
- OAuth1 header generation is placeholder (will be fully implemented in Story 3.4)

### File List

**Source Files:**
- `src/auth/auth-strategy.ts` - AuthStrategy interface, Credentials type, AuthConfig interface
- `src/auth/auth-manager.ts` - AuthManager class, CredentialStorage interface, StubCredentialStorage
- `src/auth/errors.ts` - Authentication error classes (AuthenticationError, InvalidCredentialsError, TokenExpiredError)
- `src/auth/strategies/stub-strategy.ts` - Stub authentication strategy for testing
- `src/index.ts` - Updated to instantiate AuthManager with dependencies

**Test Files:**
- `tests/unit/auth/auth-manager.test.ts` - Comprehensive unit tests for AuthManager (18 tests, all passing)
- `tests/integration/call-id-tool.test.ts` - Updated to use new AuthManager constructor

### Change Log

(To be filled by QA Agent)
