# Story 1.8: Search CLI for Early Validation

## Status

Ready for Review

## Story

**As a** developer,  
**I want** a simple CLI tool to test semantic search interactively,  
**so that** I can validate >85% relevance target with beta testers before integrating MCP protocol.

## Acceptance Criteria

1. CLI tool `src/cli/search-test.ts` implementado
2. Tool aceita query como argument: `npm run search "how to create issue"`
3. Tool chama SemanticSearchService.search() e exibe results formatados (table format com columns: rank, operationId, summary, score)
4. Tool tem flag `--limit N` para configurar número de results (default 5)
5. Tool tem flag `--verbose` para mostrar full description de operations
6. Tool tem flag `--threshold X` para filtrar results abaixo de similarity score X
7. Tool tem color output para legibilidade (high score green, medium yellow, low red)
8. Tool implementa error handling com mensagens user-friendly
9. Integration test valida tool executes sem crashes para 10+ sample queries
10. CLI usa thresholds e expected results do benchmark suite (1.7) para validar search quality

## Tasks / Subtasks

- [x] Task 1: Criar estrutura base do CLI tool (AC: 1, 2)
  - [x] Criar arquivo `src/cli/search-test.ts` com imports necessários
  - [x] Importar SemanticSearchService e EmbeddingsRepository
  - [x] Implementar função `main()` async que processa command-line arguments
  - [x] Parse query string do primeiro argument (`process.argv[2]`)
  - [x] Validar que query foi fornecida (exit com usage message se não)
  - [x] Adicionar script em package.json: `"search": "node dist/cli/search-test.js"`
  - [x] Implementar initialization: criar database connection e SemanticSearchService

- [x] Task 2: Implementar flags de command-line (AC: 4, 5, 6)
  - [x] **Approach**: Use `commander` library for robust argument parsing (recommended para maintainability)
  - [x] Install: `npm install commander` (if not already in dependencies)
  - [x] Implementar flag `--limit N` (default: 5)
    - Parse number e validar range (1-100)
    - Pass para service.search(query, limit)
  - [x] Implementar flag `--verbose` (boolean)
    - Se true: mostrar full description column na tabela
    - Se false: mostrar apenas summary (default)
  - [x] Implementar flag `--threshold X` (default: 0.0)
    - Parse number e validar range (0.0-1.0)
    - Filtrar results: `results.filter(r => r.similarity_score >= threshold)`
  - [ ] Implementar flag `--help` com usage documentation (commander provides this automatically)

- [x] Task 3: Executar search e formatar results (AC: 3)
  - [x] Chamar `service.search(query, limit)` e capturar results
  - [x] Formatar results em table format usando biblioteca `cli-table3`
  - [x] Columns da tabela:
    - **Rank**: Index do result (1-based)
    - **Operation ID**: operation_id string
    - **Summary**: summary string (truncado se >60 chars)
    - **Score**: similarity_score formatado (2 decimais)
  - [x] Se `--verbose`: adicionar column **Description** com full description
  - [x] Se results vazio: exibir mensagem "No results found for query: {query}"
  - [x] Log total results count: "Found {count} results matching '{query}'"

- [x] Task 4: Implementar color output (AC: 7)
  - [x] Usar biblioteca `chalk` para color formatting
  - [x] Color thresholds baseados em similarity_score:
    - **High** (≥0.85): Green (chalk.green)
    - **Medium** (0.70-0.84): Yellow (chalk.yellow)
    - **Low** (<0.70): Red (chalk.red)
  - [x] Aplicar color apenas na column Score
  - [x] Adicionar emoji indicators: ✅ (high), ⚠️ (medium), ❌ (low)
  - [x] Formatar score: `chalk.green('0.96 ✅')`

- [x] Task 5: Implementar error handling (AC: 8)
  - [x] Wrap main() em try/catch
  - [x] Error types e mensagens user-friendly:
    - Database não encontrado: "Database not found. Run 'npm run populate-db' first."
    - Service initialization failure: "Failed to initialize search service: {error}"
    - Search execution error: "Search failed: {error}"
    - Invalid arguments: "Invalid argument: {reason}. Use --help for usage."
  - [x] Exit codes:
    - 0: Success
    - 1: Invalid arguments
    - 2: Database error
    - 3: Search execution error
  - [x] Log errors usando Logger (não console.error)

- [x] Task 6: Integrar com benchmark suite thresholds (AC: 10)
  - [x] Importar BENCHMARK_CASES do arquivo `tests/benchmarks/search-relevance.test.ts`
  - [x] Implementar flag `--benchmark` (boolean)
  - [x] Se `--benchmark` ativo:
    - Para cada query executada, verificar se existe em BENCHMARK_CASES
    - Se existir: comparar actual top-5 operationIds com expected
    - Calcular Precision@5 para a query
    - Exibir resultado: "✅ Precision@5: 0.80" ou "❌ Below threshold (0.60 < 0.85)"
  - [x] Adicionar flag `--batch` para executar múltiplas queries de arquivo
    - Formato arquivo: uma query por linha
    - Exemplo: `npm run search --batch queries.txt --benchmark`

- [x] Task 7: Implementar integration tests (AC: 9)
  - [x] Criar arquivo `tests/integration/cli-search.test.ts`
  - [x] Setup: garantir que database exists (usar test database fixture)
  - [x] Test cases:
    - "should execute search with default parameters"
    - "should respect --limit flag"
    - "should respect --threshold flag"
    - "should handle invalid query gracefully"
    - "should handle missing database gracefully"
  - [x] 10+ sample queries para validar:
    - "create issue", "update assignee", "delete project"
    - "add user to group", "start sprint", "create custom field"
    - "transition workflow", "get board", "archive project"
    - "invalid query with special chars", ""
  - [x] Assertions: tool exits with code 0, output contains expected format
  - [x] Não validar exact results (semantic search pode variar), apenas format

- [x] Task 8: Documentar CLI usage (AC: 8)
  - [x] Adicionar README section: "## Testing Semantic Search"
  - [x] Documentar comandos:
    - `npm run search "query text"`
    - `npm run search "query" -- --limit 10`
    - `npm run search "query" -- --verbose --threshold 0.80`
    - `npm run search "query" -- --benchmark`
  - [x] Adicionar examples de output esperado
  - [x] Documentar color indicators e seus significados
  - [x] Explicar como interpretar similarity scores
  - [x] Adicionar troubleshooting tips: "Database not found" → run populate-db

## Dev Notes

### Architecture Context

**Project Structure** [Source: architecture/unified-project-structure.md]
- CLI tools pertencem ao diretório `src/cli/`
- Este é o segundo CLI tool (após `setup-wizard.ts`)
- CLI deve ser executável via `npm run search` definido em package.json
- Estrutura: CLI → Services → Core → Data (dependency flow)

**Tech Stack** [Source: architecture/tech-stack.md]
- **Runtime**: Node.js 22+ LTS
- **Language**: TypeScript 5.x (strict mode)
- **CLI Libraries**: 
  - `cli-table3`: Table formatting (já usado no projeto se disponível)
  - `chalk`: Color output terminal
  - `commander` (opcional): Argument parsing (ou usar process.argv manualmente)
- **Testing**: Vitest (integration tests para validar execução)

### Service Layer

**SemanticSearchService** [Source: Story 1.6, architecture/unified-project-structure.md]
- Já implementado em `src/services/semantic-search.ts`
- Método principal: `search(query: string, limit: number = 5): Promise<SearchResult[]>`
- Retorna array de SearchResult ordenado por similarity_score descending
- SearchResult interface:
  ```typescript
  interface SearchResult {
    operation_id: string;
    similarity_score: number; // 0-1 cosine similarity
    summary: string;
    description: string;
    operation: Operation; // Joined data
  }
  ```

**EmbeddingsRepository** [Source: architecture/unified-project-structure.md]
- Located em `src/data/embeddings-repository.ts`
- Gerencia conexão com sqlite-vec database
- Database location: `data/embeddings.db`

### Data Models

**SearchResult Interface** [Source: architecture/data-models.md#Embedding]
```typescript
interface SearchResult {
  operation_id: string;
  similarity_score: number; // 0-1 cosine similarity
  summary: string;
  description: string;
  operation: Operation; // Joined data com full details
}
```

**Operation Interface** [Source: architecture/data-models.md#Operation]
```typescript
interface Operation {
  operation_id: string;
  path: string;
  method: HttpMethod;
  summary: string;
  description: string;
  tags: string[];
  // ... outros campos
}
```

### File Locations

**CLI Structure** [Source: architecture/unified-project-structure.md]
```
src/
└── cli/
    ├── setup-wizard.ts       # EXISTE: Interactive setup
    └── search-test.ts        # CRIAR: Standalone search CLI
```

**Package.json Script**:
```json
{
  "scripts": {
    "search": "node dist/cli/search-test.js"
  }
}
```

### Command-Line Arguments Processing

**Approach Options**:
1. **Manual Parsing** (simples, zero dependencies):
   ```typescript
   const args = process.argv.slice(2);
   const query = args[0];
   const limitIdx = args.indexOf('--limit');
   const limit = limitIdx !== -1 ? parseInt(args[limitIdx + 1]) : 5;
   ```

2. **Commander Library** (estruturado, mas adiciona dependency):
   ```typescript
   import { Command } from 'commander';
   const program = new Command();
   program
     .argument('<query>', 'Search query')
     .option('-l, --limit <n>', 'Number of results', '5')
     .option('-v, --verbose', 'Show full descriptions')
     .parse();
   ```

**Recomendação**: Manual parsing é suficiente para este CLI simples (menos dependencies).

### Color Output Strategy

**Chalk Usage** [Source: architecture/tech-stack.md]
- Biblioteca `chalk` para terminal colors
- Installation: `npm install chalk`
- Usage:
  ```typescript
  import chalk from 'chalk';
  
  function colorizeScore(score: number): string {
    if (score >= 0.85) return chalk.green(`${score.toFixed(2)} ✅`);
    if (score >= 0.70) return chalk.yellow(`${score.toFixed(2)} ⚠️`);
    return chalk.red(`${score.toFixed(2)} ❌`);
  }
  ```

**Score Thresholds** [Source: Story 1.7]
- High (≥0.85): Green - Matches benchmark threshold de >85% relevance
- Medium (0.70-0.84): Yellow - Acceptable mas abaixo do threshold
- Low (<0.70): Red - Poor match

### Table Formatting

**cli-table3 Library**:
```typescript
import Table from 'cli-table3';

const table = new Table({
  head: ['Rank', 'Operation ID', 'Summary', 'Score'],
  colWidths: [6, 30, 50, 12]
});

results.forEach((result, idx) => {
  table.push([
    idx + 1,
    result.operation_id,
    result.summary.substring(0, 47) + '...', // Truncate
    colorizeScore(result.similarity_score)
  ]);
});

console.log(table.toString());
```

### Error Handling Standards

**Error Types** [Source: architecture/coding-standards.md]
- Sempre usar try/catch em async functions
- Custom error messages para cada scenario
- Exit codes distintos para different error types
- Log errors usando Logger, não console.error

**Database Errors**:
- Se `data/embeddings.db` não existe → Exit code 2
- Message: "Database not found. Run 'npm run populate-db' first."
- Suggestion: Link para documentação de setup

**Invalid Arguments**:
- Query vazia → Exit code 1
- Flags inválidas → Exit code 1
- Message: "Invalid argument: {reason}. Use --help for usage."

### Benchmark Integration

**BENCHMARK_CASES Reference** [Source: Story 1.7]
- Array definido em `tests/benchmarks/search-relevance.test.ts`
- Structure:
  ```typescript
  interface BenchmarkCase {
    query: string;
    expectedIds: string[]; // Top-5 expected operationIds
  }
  
  const BENCHMARK_CASES: BenchmarkCase[] = [
    { query: 'create issue', expectedIds: ['create_issue', ...] },
    // ... 50+ cases
  ];
  ```

**Precision@5 Calculation** [Source: Story 1.7]
```typescript
function calculatePrecisionAt5(
  actualIds: string[], 
  expectedIds: string[]
): number {
  const relevant = actualIds.slice(0, 5).filter(id => 
    expectedIds.includes(id)
  );
  return relevant.length / 5;
}
```

### Coding Standards

**Key Standards** [Source: architecture/coding-standards.md]
- **Type Safety**: TypeScript strict mode, no `any` types
- **Naming**: 
  - Functions: camelCase (`formatResults`, `colorizeScore`)
  - Constants: UPPER_SNAKE_CASE (`DEFAULT_LIMIT`, `COLOR_THRESHOLDS`)
- **Logging**: Use Logger (pino), não console.log
- **Error Handling**: Try/catch em async functions, custom error classes
- **Immutability**: Prefer const, não mutar arrays/objects

**CLI-Specific Guidelines**:
- Output para stdout: results e informational messages
- Output para stderr: errors e warnings
- Exit codes: 0 = success, non-zero = error (diferentes por tipo)
- Color output: detectar se terminal supports colors (chalk detecta automático)

### Testing Strategy

**Integration Test Organization** [Source: architecture/testing-strategy.md]
- File location: `tests/integration/cli-search.test.ts`
- Testing framework: Vitest
- Test approach: Execute CLI via child_process e validar output

**Test Example**:
```typescript
import { describe, it, expect } from 'vitest';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

describe('CLI Search Tool', () => {
  it('should execute search with default parameters', async () => {
    const { stdout, stderr } = await execAsync(
      'npm run search "create issue"'
    );
    
    expect(stderr).toBe('');
    expect(stdout).toContain('Rank');
    expect(stdout).toContain('Operation ID');
    expect(stdout).toContain('create_issue');
  });
  
  it('should respect --limit flag', async () => {
    const { stdout } = await execAsync(
      'npm run search "update issue" -- --limit 3'
    );
    
    // Count table rows (should be 3 + header)
    const lines = stdout.split('\n').filter(l => l.includes('│'));
    expect(lines.length).toBeLessThanOrEqual(5); // Header + 3 rows + border
  });
});
```

**Test Coverage** [Source: architecture/testing-strategy.md]
- Integration tests suficientes (não precisa unit tests para CLI simples)
- Validar: tool executes, output format correct, error handling
- Não validar: exact search results (semantic search pode variar)

### Performance Considerations

**CLI Execution Time**:
- Query embedding generation: ~150ms (Transformers.js local)
- Database search: <100ms (sqlite-vec cosine similarity)
- Total esperado: ~250ms por query
- Acceptable para CLI tool interativo

**Database Setup**:
- Assume `data/embeddings.db` já existe (populated via script)
- Se não existe: tool deve fail gracefully com clear message
- Não tentar criar ou populate database automaticamente

### Dependencies

**Required npm Packages**:
- `cli-table3`: ^0.6.3 - Table formatting
- `chalk`: ^5.3.0 - Terminal colors
- Ambos devem ser adicionados ao package.json dependencies

**Installation Command**:
```bash
npm install cli-table3 chalk
```

### Usage Examples

**Basic Search**:
```bash
npm run search "create issue"
```

**With Limit**:
```bash
npm run search "update assignee" -- --limit 10
```

**With Threshold**:
```bash
npm run search "delete project" -- --threshold 0.80
```

**Verbose Output**:
```bash
npm run search "transition workflow" -- --verbose
```

**Benchmark Mode**:
```bash
npm run search "create issue" -- --benchmark
```

**Combined Flags**:
```bash
npm run search "start sprint" -- --limit 3 --verbose --threshold 0.85
```

### Expected Output Format

**Standard Output**:
```
┌──────┬──────────────────────────────┬──────────────────────────────────────────────────┬──────────────┐
│ Rank │ Operation ID                  │ Summary                                          │ Score        │
├──────┼──────────────────────────────┼──────────────────────────────────────────────────┼──────────────┤
│ 1    │ create_issue                  │ Create a new issue in the specified project      │ 0.96 ✅      │
│ 2    │ create_issue_meta             │ Get metadata for issue creation                  │ 0.89 ✅      │
│ 3    │ bulk_create_issues            │ Create multiple issues in bulk                   │ 0.82 ⚠️      │
│ 4    │ create_issue_link             │ Create a link between two issues                 │ 0.78 ⚠️      │
│ 5    │ issue_picker_suggestions      │ Get issue suggestions for autocomplete           │ 0.65 ❌      │
└──────┴──────────────────────────────┴──────────────────────────────────────────────────┴──────────────┘

Found 5 results matching 'create issue'
```

**Verbose Output** (--verbose flag):
Adiciona column **Description** com full description text.

**Benchmark Mode Output** (--benchmark flag):
```
┌──────┬──────────────────────────────┬──────────────────────────────────────────────────┬──────────────┐
│ Rank │ Operation ID                  │ Summary                                          │ Score        │
├──────┼──────────────────────────────┼──────────────────────────────────────────────────┼──────────────┤
│ 1    │ create_issue                  │ Create a new issue in the specified project      │ 0.96 ✅      │
│ 2    │ create_issue_meta             │ Get metadata for issue creation                  │ 0.89 ✅      │
│ 3    │ bulk_create_issues            │ Create multiple issues in bulk                   │ 0.82 ⚠️      │
│ 4    │ create_issue_link             │ Create a link between two issues                 │ 0.78 ⚠️      │
│ 5    │ issue_picker_suggestions      │ Get issue suggestions for autocomplete           │ 0.65 ❌      │
└──────┴──────────────────────────────┴──────────────────────────────────────────────────┴──────────────┘

Benchmark Results:
✅ Precision@5: 0.80 (4/5 expected operations in top 5)
Expected: ['create_issue', 'create_issue_meta', 'bulk_create_issues', 'update_issue', 'get_issue']
Actual:   ['create_issue', 'create_issue_meta', 'bulk_create_issues', 'create_issue_link', 'issue_picker_suggestions']
```

### Testing

**Test Framework** [Source: architecture/testing-strategy.md]
- Vitest (integration tests)
- File location: `tests/integration/cli-search.test.ts`

**Test Execution**:
```bash
npm test cli-search           # Run specific test file
npm test                      # Run all tests (includes CLI tests)
```

**Test Strategy**:
- Execute CLI via child_process
- Validate output format (não exact results)
- Test error scenarios com invalid inputs
- Test all flags combinations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-15 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-01-15 | 1.1 | Story approved and ready for development | Bob (Scrum Master) |
| 2025-10-16 | 1.2 | Story validated and approved - Fixed language consistency in user story statement | Sarah (PO) |
| 2025-10-16 | 1.3 | Clarified CLI argument parsing approach (use commander library), added installation note and automatic --help generation. Final validation: APPROVED. | GitHub Copilot |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

- GitHub Copilot (GPT-5-Codex)

### Debug Log References

- 2025-10-17T13:18:00Z · `npm install`
- 2025-10-17T13:19:30Z · `npm run lint`
- 2025-10-17T13:40:49Z · `npm test -- tests/integration/cli-search.test.ts`

### Completion Notes List

- CLI scaffolding implemented with commander-based argument parsing, colorised output, and benchmark integrations.
- Added search runtime script plus npm dependencies (commander, chalk, cli-table3) to support the tool.
- Updated story task checklist to reflect completed CLI functionality.
- Added dedicated integration suite covering CLI happy-path, limit/threshold filtering, benchmark reporting, batch execution, and error handling.
- Documented CLI usage in README, including flag guide, sample output, and troubleshooting tips for the embeddings database setup.

### File List

- src/cli/search-test.ts
- package.json
- package-lock.json
- docs/stories/1.8.search-cli-for-early-validation.md
- tests/integration/cli-search.test.ts
- README.md

## QA Results

_This section will be populated by QA Agent after implementation review._

